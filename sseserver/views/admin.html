<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ssestreamer admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css" />

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.4.0/jquery.timeago.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>

    <style media="screen">
      @media (max-width: 640px) {
        body{font-size: 12px;}
      }
    </style>
  </head>
  <body>
    <article class="container">
      <h2>system info</h2>
      <ul>
        <li>uptime:</li>
        <li>messages broadcast (origin):</li>
        <li>messages broadcast (remote):</li>
        <li>memory usage:</li>
        <li>goroutines:</li>
      </ul>
      <h2>open streams <small>N open</small></h2>
      <!-- <div class="table-responsive"> -->
        <table class="table table-striped table-hover table-condensed">
          <thead>
            <th><i class="fa fa-tag"></i>&nbsp;namespace</th>
            <th><i class="fa fa-globe"></i>&nbsp;client</th>
            <th class="hidden-xs"><i class="fa fa-flag"></i>&nbsp;established</th>
            <th><i class="fa fa-clock-o"></i>&nbsp;age</th>
          </thead>
          <tbody>
          </tbody>
        </table>
      <!-- </div> -->
    </article>

    <script id="entry-template" type="text/x-handlebars-template">
      <tr>
        <td>
          <code>{{request_path}}</code>
        </td>
        <td>
          <i class="{{icon}}" title="{{user_agent}}"></i>
          &nbsp;
          <tt>{{remote_ip}}</tt>
        </td>
        <td class="hidden-xs">
          <time datetime="{{created_iso}}">{{created_at}}</time>
        </td>
        <td>
          <i class="fa fa-clock-o hidden-xs"></i>
          <time class="timeago" datetime="{{created_iso}}">{{created_at}}</time>
        </td>
      </tr>
    </script>

    <script type="text/javascript">
      // object we stick compiled HB templates in
      Handlebars.templates = {};

      // override timeago settings for shorter format
      jQuery.timeago.settings.strings = {
        prefixAgo: null,
        prefixFromNow: null,
        suffixAgo: "",
        suffixFromNow: "",
        seconds: "1m",
        minute: "1m",
        minutes: "%dm",
        hour: "1h",
        hours: "%dh",
        day: "1d",
        days: "%dd",
        month: "1mo",
        months: "%dmo",
        year: "1yr",
        years: "%dyr",
        wordSeparator: " ",
        numbers: []
      };

      // render status from server
      var renderTable = function() {
        $.get("/admin/status.json", function(response) {
          console.log(response);
          response.connections.forEach( function(entry) {
            // console.log(entry.client_ip);
            renderTableEntry(entry);
          });
        }, "json");
      }

      // render individual status entry
      var renderTableEntry = function(client) {
        var context = {
          request_path: client.namespace,
          remote_ip: client.client_ip,
          user_agent: client.user_agent,
          // icon: "icon-" + pickPlatformIcon(client.user_agent)
          created_at: new Date(client.created_at * 1000),
          created_iso: new Date(client.created_at * 1000).toISOString(),
          age: Math.floor(Date.now() / 1000) - client.created_at,
        };
        var rendered_entry = Handlebars.templates.entry(context);
        $("tbody").append(rendered_entry);
        $("time.timeago").timeago();
      }


      $(document).ready( function() {
        // compile handlebars template for list entries
        Handlebars.templates.entry = Handlebars.compile( $('#entry-template').html() );

        // render the current server status to table
        renderTable();

        // attach timeago plugin to timestamps
        // $("time.timeago").timeago();

        console.log("loaded!");
      });
    </script>
  </body>
</html>
